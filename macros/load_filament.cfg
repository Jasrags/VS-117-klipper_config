[gcode_macro LOAD_FILAMENT]
description: Load filament
gcode:
  {% set extruder_min_add = printer['gcode_macro _USER_VARIABLE'].extruder_min_add|int %}
  {% set load_distance = printer['gcode_macro _USER_VARIABLE'].load_distance|int %}
  {% set load_extrude = printer['gcode_macro _USER_VARIABLE'].load_extrude|int %}
  {% set unload_distance = printer['gcode_macro _USER_VARIABLE'].unload_distance|int %}
  {% set retract_pause = printer['gcode_macro _USER_VARIABLE'].retract_pause|int %}
  {% set z_min_delta = printer['gcode_macro _USER_VARIABLE'].z_min_delta|float %}
  {% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int + extruder_min_add %}
  {% set extruder_target = printer.extruder.target %}

  {% if printer['gcode_macro _USER_VARIABLE'].debug == 1 %}
    {action_respond_info('==== LOAD_FILAMENT ====')}
    {action_respond_info("extruder_min_add: %s" % (extruder_min_add))}
    {action_respond_info("load_distance: %s" % (load_distance))}
    {action_respond_info("load_extrude: %s" % (load_extrude))}
    {action_respond_info("unload_distance: %s" % (unload_distance))}
    {action_respond_info("retract_pause: %s" % (retract_pause))}
    {action_respond_info("extruder_target: %s" % (extruder_target))}
    {action_respond_info("minTemp: %s" % (minTemp))}
    {action_respond_info("z_min_delta: %s" % (z_min_delta))}
    {action_respond_info('===============')}
  {% endif %}

  SAVE_GCODE_STATE NAME=LOAD_FILAMENT
  PARK_FRONT_MID
  G90 ; absolute positioning

  {% if printer.extruder.can_extrude|lower == 'false' %}
    {action_respond_info("Extruder Temp to low heat to %2dC" % minTemp)}
    G1 Z{z_min_delta} F1800 
    M109 S{minTemp} ; heat extruder and wait
  {% endif %}
  M83 ; set extruder to relative
  G1 E{load_distance} F1800 ; quickly load 90mm filament
  G1 E{load_extrude} F300 ; slower extrusion for hotend path
  G1 E{retract_pause} F1000 ; retract 

  SAVE_VARIABLE VARIABLE=filament_loaded VALUE='"true"'

  M109 S{extruder_target} ; restore old extruder temperature
  RESTORE_GCODE_STATE NAME=LOAD_FILAMENT