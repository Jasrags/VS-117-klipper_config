[gcode_macro PRINT_START]
gcode:
  {% if printer['gcode_macro _USER_VARIABLE'].debug == 1 %}
    {% set target_bed = params.BED|default(110)|int %}
    {% set target_extruder = params.EXTRUDER|default(150)|int %}
    {% set target_chamber = params.CHAMBER|default(0)|int %}
    {% set filament_type = params.FILAMENT|default("ABS")|upper %}
    {% set preheat_filament_types = printer['gcode_macro _USER_VARIABLE'].preheat_filament_types %}
    {% set ena_auto_z_offset = printer['gcode_macro _USER_VARIABLE'].auto_z_offset|lower %}
    {% set ena_quad_gantry_level = printer['gcode_macro _USER_VARIABLE'].quad_gantry_level|lower %}
    {% set ena_bed_mesh = printer['gcode_macro _USER_VARIABLE'].bed_mesh|lower %}

    {action_respond_info('==== PRINT_START ====')}
    {action_respond_info("targets [bed: %s, extruder: %s, chamber: %s]" % (target_bed,target_extruder,target_chamber))}
    {action_respond_info("filament_type: %s" % (filament_type))}
    {action_respond_info("preheat_filament_types: %s" % (preheat_filament_types|join(',')))}
    {action_respond_info("ena_auto_z_offset: %s" % (ena_auto_z_offset))}
    {action_respond_info("ena_quad_gantry_level: %s" % (ena_quad_gantry_level))}
    {action_respond_info("ena_bed_mesh: %s" % (ena_bed_mesh))}
    {action_respond_info('===============')}
  {% endif %}

  blue
  M117 Homing
  _CG28

  PREHEAT_CHAMBER BED={target_bed} CHAMBER={target_chamber} FILAMENT={filament_type}

  {% if ena_quad_gantry_level == "true" or ena_bed_mesh == "true" or ena_auto_z_offset == "z_calib" %}
    {% if ena_quad_gantry_level == "true" %}
      M117 Calibrating QGL
      {action_respond_info('Calibrating QGL')}
      QUAD_GANTRY_LEVEL
      G4 P3000
    {% endif %}

    {% if ena_bed_mesh == "true" %}
      M117 Calibrating Mesh
      {action_respond_info('Calibrating Mesh')}
      BED_MESH_CALIBRATE
      BED_MESH_PROFILE LOAD=default
      _CG28
    {% endif %}

    {% if ena_auto_z_offset == "z_calib" %}
      M117 Calibrating Z
      {action_respond_info('Calibrating Z')}
      CALIBRATE_Z
    {% endif %}
  {% endif %}

  M117 Heating ~extruder~: {target_extruder}~degrees~
  M109 S{target_extruder} # Wait for extruder final temp
  G1 Z5 F5000 # Move head 5mm from bed surface
  M83 # Make the E relative independant of other axis
  G1 E9 F1500 # Unretract filament
  RESET_EXTRUDER

  white
  M117 Printing
